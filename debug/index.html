<!DOCTYPE html>
<html>
<head>
    <title>debug page</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #canvas { border: 10px dashed #ccc; }
        #canvas.hover { border: 10px dashed #333; }
    </style>
</head>

<body>
    <script src='geojson-vt-dev.js'></script>
    <canvas id="canvas"></canvas>
    <script>

        var extent = 4096,
            totalExtent = 4096 * (1 + 0.05 * 2),

            tileIndex,

            canvas = document.getElementById('canvas'),
            ctx = canvas.getContext('2d'),
            height = canvas.height = canvas.width = window.innerHeight - 40,
            ratio = height / totalExtent,
            pad = 4096 * 0.05 * ratio,

            x = 0,
            y = 0,
            z = 0;

        if (devicePixelRatio > 1) {
            canvas.style.width = canvas.width + 'px';
            canvas.style.height = canvas.height + 'px';
            canvas.width *= 2;
            canvas.height *= 2;
            ctx.scale(2, 2);
        }

        function humanFileSize(size) {
            var i = Math.floor(Math.log(size) / Math.log(1024));
            return Math.round(100 * (size / Math.pow(1024, i))) / 100 + ' ' + ['B', 'kB', 'MB', 'GB'][i];
        };

        canvas.ondragover = function () { this.className = 'hover'; return false; };
        canvas.ondragend = function () { this.className = ''; return false; };
        canvas.ondrop = function (e) {
            this.className = '';

            var reader = new FileReader();
            reader.onload = function (event) {
                console.log('data size', humanFileSize(event.target.result.length));
                console.time('data parsed');
                var data = JSON.parse(event.target.result);
                console.timeEnd('data parsed');

                tileIndex = geojsonvt(data, {
                    maxZoom: 14,
                    debug: 1
                });

                drawTile();
            };
            reader.readAsText(e.dataTransfer.files[0]);

            e.preventDefault();
            return false;
        };

        ctx.lineWidth = 1;
        ctx.strokeStyle = 'rgba(255,0,0,0.5)';
        ctx.fillStyle = 'rgba(255,0,0,0.1)';

        function drawTile() {
            ctx.clearRect(0, 0, height, height);

            var tile = tileIndex.getTile(z, x, y);
            if (!tile) {
                console.log('not found', tile);
                return;
            }

            var features = tile.features;

            for (var i = 0; i < features.length; i++) {
                var feature = features[i],
                    type = feature.type;

                for (var j = 0; j < feature.geometry.length; j++) {
                    var ring = feature.geometry[j];

                    ctx.beginPath();

                    for (var k = 0; k < ring.length; k++) {
                        var p = ring[k];
                        if (k) ctx.lineTo(p[0] * ratio + pad, p[1] * ratio + pad);
                        else ctx.moveTo(p[0] * ratio + pad, p[1] * ratio + pad);
                    }
                }

                if (type === 3) ctx.fill('evenodd');
                ctx.stroke();
            }
        }

        canvas.onclick = function (e) {
            if (!tileIndex) return;

            var mouseX = e.layerX - 10,
                mouseY = e.layerY - 10,
                left = mouseX / height < 0.5,
                top = mouseY / height < 0.5;

            z++;
            x *= 2;
            y *= 2;
            if (!left) x++;
            if (!top) y++;

            drawTile();
        };

        function toID(z, x, y) {
            return (((1 << z) * y + x) * 32) + z;
        }

    </script>
</body>
</html>
